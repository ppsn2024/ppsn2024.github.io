<section id="roomplan" class="background-light subpage-sec">
    <!-- <div class="session-information">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12" id="session">
                    <h3>Poster Session 1</h3>
                    <p>12:00-14:00</p>
                </div>
            </div>
        </div>
    </div> -->
    <div id="paperSlider" class="planerContainer">
        <button type="button" id="moveLeft" class="btn-nav">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div class="slider" id="mySlider">

        </div>
        <button type="button" id="moveRight" class="btn-nav">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    </div>
    <div class="container-fluid">
        <div class="row information">
            <div class="col-lg-6 col-md-6 col-sm-12 green-bg">
                <div id="paperInfo" class="paperInfo">
                    <div class="container">
                        <h2 id="paperTitle"></h2>
                        <p id="paperAuthors" class="text-justify paperAuthors">

                        </p>
                        <p id="paperAbstract" class="text-justify paperAbstract">

                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12">
                <div class="svgPlan">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                        x="0px" y="0px" viewBox="0 0 1200 1247.18" style="enable-background:new 0 0 1200 1247.18;"
                        xml:space="preserve">
                        <style type="text/css">
                            .st0 {
                                fill: #DDDDDD;
                            }

                            .st1 {
                                fill: #999999;
                            }

                            .st2 {
                                fill: none;
                                stroke: #999999;
                                stroke-width: 3;
                                stroke-miterlimit: 10;
                            }

                            .st3 {
                                fill: #666666;
                            }

                            .st4 {
                                display: none;
                            }
                        </style>
                        <g id="boundaries">
                            <g id="room">
                                <polygon class="st0"
                                    points="886,135.63 886,72.63 313,72.63 313,135.63 101,135.63 101,1176.63 1099,1079.63 1099,135.63 		" />
                            </g>
                        </g>
                        <g id="basics">
                            <g id="frontdesk">
                                <rect x="556" y="190.13" class="st1" width="280" height="80" />
                            </g>
                            <g id="door-west">

                                <rect x="176" y="130.64"
                                    transform="matrix(-1 -4.489266e-11 4.489266e-11 -1 452 271.2879)" class="st1"
                                    width="100" height="10" />

                                <rect x="266" y="51.07" transform="matrix(-1 -4.492907e-11 4.492907e-11 -1 542 191.709)"
                                    class="st1" width="10" height="89.58" />
                                <path class="st2" d="M177.51,131.07c0,0-3.56-78.51,88.49-78.51" />
                            </g>
                            <g id="door-east">

                                <rect x="989" y="130.74"
                                    transform="matrix(-1 -4.491086e-11 4.491086e-11 -1 2078 271.481)" class="st1"
                                    width="100" height="10" />

                                <rect x="1079" y="51.16"
                                    transform="matrix(-1 -4.502011e-11 4.502011e-11 -1 2168 191.902)" class="st1"
                                    width="10" height="89.58" />
                                <path class="st2" d="M990.51,131.16c0,0-3.56-78.51,88.49-78.51" />
                            </g>
                            <g id="blackboard">
                                <rect x="630" y="72.63" class="st1" width="226" height="10" />
                            </g>
                            <g id="beamer-screen">
                                <rect x="343" y="72.63" class="st1" width="267" height="10" />
                            </g>
                            <g id="window-northeast">
                                <rect x="1089" y="309.63" class="st1" width="10" height="300" />
                            </g>
                            <g id="window-southeast">
                                <rect x="1089" y="706.63" class="st1" width="10" height="300" />
                            </g>
                        </g>
                        <g id="setup">

                            <rect id="p_10" x="464.89" y="324.63"
                                transform="matrix(-1 -4.489887e-11 4.489887e-11 -1 989.7822 769.2632)" class="st3"
                                width="60" height="120" />

                            <rect id="p_9" x="464.89" y="474.63"
                                transform="matrix(-1 -4.489887e-11 4.489887e-11 -1 989.7822 1069.2632)" class="st3"
                                width="60" height="120" />

                            <rect id="p_8" x="464.89" y="624.63"
                                transform="matrix(-1 -4.489887e-11 4.489887e-11 -1 989.7822 1369.2632)" class="st3"
                                width="60" height="120" />

                            <rect id="p_7" x="464.89" y="774.63"
                                transform="matrix(-1 -4.489887e-11 4.489887e-11 -1 989.7822 1669.2632)" class="st3"
                                width="60" height="120" />

                            <rect id="p_6" x="494.89" y="894.63"
                                transform="matrix(-4.489938e-11 1 -1 -4.489938e-11 1479.5227 429.7405)" class="st3"
                                width="60" height="120" />

                            <rect id="p_5" x="644.89" y="894.63"
                                transform="matrix(-1.836970e-16 1 -1 -1.836970e-16 1629.5227 279.7405)" class="st3"
                                width="60" height="120" />
                            <rect id="p_4" x="674.89" y="774.63" class="st3" width="60" height="120" />
                            <rect id="p_3" x="674.89" y="624.63" class="st3" width="60" height="120" />
                            <rect id="p_2" x="674.89" y="474.63" class="st3" width="60" height="120" />
                            <rect id="p_1" x="674.89" y="324.63" class="st3" width="60" height="120" />
                        </g>
                        <g id="rulers" class="st4">
                        </g>
                    </svg>
                </div>
            </div>
        </div>
    </div>


</section>
<script>
    const planData = '{{ site.data.papers}}';
    const planDataJson = planData.replaceAll("=>", ":");
    const data = JSON.parse(planDataJson);
    console.log(data);

    const paperslots = '{{ site.data.timetable.slots}}';
    const slotsString = paperslots.replaceAll("=>", ":");
    const slotsJsonString = `[${slotsString.replace(/}{/g, '},{')}]`;
    const slotsArray = JSON.parse(slotsJsonString);

    //URL params
    var queryParams = new URLSearchParams(window.location.search);
    var slotIdParam = queryParams.get("slot");
    var paperIdParam = queryParams.get('paperid');
    var posterIdParam = queryParams.get('posterid');
    const title = document.getElementById("paperTitle");
    const authors = document.getElementById("paperAuthors");
    const abstract = document.getElementById("paperAbstract");
    const paperSlider = document.getElementById("paperSlider")

    if (slotIdParam == null) {
        slotIdParam = "s3_5";
    }
    const papersPerSlot = getPapersBySlotId(slotIdParam);
    const slot = getSessionBySlotId(slotIdParam);

    if (slot.class != "session") {
        paperSlider.style.display = "none";
    }



    /////////// Set papers in slider
    const slider = document.getElementById("mySlider");

    function addPapersToSlider(papers, slider) {
        papers.forEach(paper => {
            // Create the paper div
            const paperDiv = document.createElement('div');
            paperDiv.className = 'paper';
            paperDiv.id = paper.ID;

            // Create the content div
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';

            // Create the h4 element for ID
            const h4 = document.createElement('h4');
            h4.textContent = `ID: #${paper.ID}`;

            // Create the p element for Title
            const p = document.createElement('p');
            p.textContent = paper.Title;

            // Append h4 and p to contentDiv
            contentDiv.appendChild(h4);
            contentDiv.appendChild(p);
            // Append contentDiv to paperDiv
            paperDiv.appendChild(contentDiv);
            // Append paperDiv to slider
            slider.appendChild(paperDiv);
        });
    }

    addPapersToSlider(papersPerSlot, slider);


    function getPapersBySlotId(slotId) {
        let papers = [];
        for (const paper of data.papers) {
            if (paper.slot_id == slotId) {
                papers.push(paper);
            }
        }

        return papers;
    }

    function getSessionBySlotId(slotId) {
        return getElementById(slotsArray, slotId)
    }

    function getElementById(array, id) {
        return array.find(obj => obj.id === id);
    }


    //colorPosterSVG(currentPaper.roomposition);


    function colorPosterSVG(activeStandId) {
        const stands = document.querySelectorAll(".st3");
        const activeStand = document.querySelector("#" + activeStandId);
        stands.forEach(x => {
            x.classList.remove("active");
        });
        activeStand.classList.add("active");
    }

    function getPaperById(paperId) {
        for (const paper of data.papers) {
            if (paper.ID == paperId) {
                return paper;
            }
        }

        return null; // Return null if paper with given ID is not found
    }

    //Add event listeners to the papers
    const papers = document.querySelectorAll(".paper");
    let lastClicked = null;
    papers.forEach(paper => {
        paper.onclick = function () {
            const paperId = this.id;
            const paper = papersPerSlot.find(p => p.ID == paperId);

            if (lastClicked) {
                lastClicked.classList.remove('active');
            }

            this.classList.add('active');

            queryParams.set("paperid", paper.ID);
            queryParams.set("posterid", paper.poster_id)
            history.pushState(null, null, "?" + queryParams.toString());
            title.innerHTML = paper.Title;
            authors.innerHTML = paper.Authors;
            abstract.innerHTML = paper.Abstract;
            colorPosterSVG(paper.poster_id);
        }
    });


    ///////////////Render informations

    //Render session information
    if (paperIdParam == null) {
        renderDetails(slot)
    } else {
        const currentPaper = getPaperById(paperIdParam);
        title.innerHTML = currentPaper.Title;
        authors.innerHTML = currentPaper.Authors;
        abstract.innerHTML = currentPaper.Abstract;
        colorPosterSVG(currentPaper.poster_id);
    }

    function renderDetails(slot) {
        if (slot.class == "session") {
            console.log(slot)
            title.innerHTML = slot.title;
            authors.innerHTML = "Session Chair: " + slot.chair;
            console.log(papersPerSlot)
            //Build Sessionplan
            let list = "<ul class='session_overview_list'>";

            papersPerSlot.forEach(paper => {
                list += "<li>" + "<span class='session_overview_list_id'>" + paper.ID + ":</span>" + " " + paper.Title + "</li>";
            });
            list += "</ul>"
            abstract.innerHTML = list;
        } else if (slot.class == "tutorial") {
            title.innerHTML = slot.title;
            authors.innerHTML = "Tutorial speakers: " + slot.speaker;
            abstract.innerHTML = slot.description;
        } else if (slot.class == "workshop") {
            title.innerHTML = slot.title;
            authors.innerHTML = "Tutorial speakers: " + slot.speaker;
            abstract.innerHTML = slot.description;
        } else if (slot.class == "break") {
            if (slot.title.includes("Lunch  ")) {
                title.innerHTML = slot.title;
                abstract.innerHTML = "Enjoy your meal at the lunch room :)"
            } else if (slot.title.includes("Coffee")) {
                title.innerHTML = slot.title;
                abstract.innerHTML = slot.description
                abstract.innerHTML = "Get a coffee and meet the people around the area"
            }
        }
    }

    function getElementById(array, id) {
        return array.find(obj => obj.id === id);
    }

    function sortById(array) {
        return array.sort((a, b) => {
            if (a.id < b.id) return -1;
            if (a.id > b.id) return 1;
            return 0;
        });
    }
</script>

<script>
    const roomSlider = document.querySelector(".slider");
    const btnLeft = document.getElementById("moveLeft");
    const btnRight = document.getElementById("moveRight");

    let baseSliderWidth = roomSlider.offsetWidth;
    let activeIndex = 0;


    btnLeft.addEventListener("click", (e) => {
        let paperWidth = document.querySelector(".paper").getBoundingClientRect()
            .width;
        let scrollDistance = paperWidth * 6; // Scroll the length of 6 papers. TODO: make work for mobile because (4 papers/page instead of 6)

        roomSlider.scrollBy({
            top: 0,
            left: -scrollDistance,
            behavior: "smooth",
        });
        activeIndex = (activeIndex - 1) % 3;
        console.log(activeIndex);
    });

    // Scroll Right button
    btnRight.addEventListener("click", (e) => {
        let paperWidth = document.querySelector(".paper").getBoundingClientRect()
            .width;
        let scrollDistance = paperWidth * 6; // Scroll the length of 6 papers. TODO: make work for mobile because (4 papers/page instead of 6)

        console.log(`paperWidth = ${paperWidth}`);
        console.log(`scrolling right ${scrollDistance}`);

        // if we're on the last page
        if (activeIndex == 2) {
            // duplicate all the items in the slider (this is how we make 'looping' slider)
            //populateSlider();
            roomSlider.scrollBy({
                top: 0,
                left: +scrollDistance,
                behavior: "smooth",
            });
            activeIndex = 0;
        } else {
            roomSlider.scrollBy({
                top: 0,
                left: +scrollDistance,
                behavior: "smooth",
            });
            activeIndex = (activeIndex + 1) % 3;
            console.log(activeIndex);
        }
    });

</script>